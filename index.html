<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Espa√±a ‚Äî Puzzle por Comunidades y Provincias</title>

  <style>
    body{margin:0;background:#f5f7ff;font-family:system-ui,sans-serif}
    .wrap{width:min(1320px,96vw);margin:0 auto;padding:16px}
    header{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:8px 12px;font-weight:900}
    button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:900}
    .btn1{background:#f97316;color:#fff}
    .btn2{background:#ef4444;color:#fff}
    .btn3{background:#10b981;color:#fff}
    .btn4{background:#6366f1;color:#fff}

    .grid{display:grid;grid-template-columns: 1fr 360px; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:12px}
    #stage{width:100%;height:min(80vh,860px);border-radius:16px;overflow:hidden}
    #stage svg{width:100%;height:100%;display:block;background:#fff}

    .tray{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-height:60vh;overflow:auto;padding-right:6px}
    .pieceBox{
      border:1px solid #bfdbfe;background:#eff6ff;border-radius:14px;
      padding:8px;display:flex;flex-direction:column;gap:8px;
      user-select:none;
      touch-action:none;
    }
    .pieceName{font-weight:900;font-size:12px;color:#0b1220}
    .mini{height:90px;border-radius:12px;background:#fff;overflow:hidden;border:1px solid #e5e7eb}
    .mini svg{width:100%;height:100%;display:block}

    .hint{color:#374151;margin-top:10px;line-height:1.4}
    .ok{color:#16a34a;font-weight:900}
    .bad{color:#dc2626;font-weight:900}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}

    .slot{
      fill:none;
      stroke:#111827;
      stroke-width:1.2;
      stroke-dasharray:7 6;
      vector-effect: non-scaling-stroke;
      pointer-events:none;
      opacity:.8;
    }
    .slot.hint{
      stroke:#f59e0b !important;
      stroke-width:2.2 !important;
      stroke-dasharray:0 !important;
      opacity:1 !important;
    }

    .prov-label{
      font-size:10px;
      font-weight:800;
      fill:#0b1220;
      paint-order: stroke;
      stroke:#ffffff;
      stroke-width:3px;
      stroke-linejoin:round;
      pointer-events:none;
      user-select:none;
    }
    .cc-label{
      font-size:18px;
      font-weight:900;
      fill:#111827;
      opacity:.88;
      paint-order: stroke;
      stroke:#ffffff;
      stroke-width:4px;
      stroke-linejoin:round;
      pointer-events:none;
      user-select:none;
    }

    .placedGlow{
      filter: drop-shadow(0 2px 6px rgba(0,0,0,.18));
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="pill">Comunidad: <span id="zone">‚Äî</span></div>
      <div class="pill">Progreso: <span id="prog">0</span>/<span id="total">0</span></div>

      <button class="btn1" id="shuffle">Mezclar bandeja</button>
      <button class="btn4" id="hintBtn">Pista</button>
      <button class="btn2" id="reset">Reiniciar comunidad</button>
      <button class="btn3" id="next">Siguiente</button>
    </header>

    <div class="grid">
      <div class="card" id="stage">
        <div id="loading" class="hint">Cargando mapa real‚Ä¶</div>
      </div>

      <div class="card">
        <b>Piezas disponibles (modo libre)</b>
        <div id="status" class="hint"></div>

        <div class="tray" id="tray"></div>

        <div class="hint">
          Arrastra cualquier provincia de la comunidad y su√©ltala cerca de su hueco para encajar.<br>
          La <b>Pista</b> resalta una provincia pendiente al azar.
        </div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const STAGE  = document.getElementById("stage");
  const LOADING= document.getElementById("loading");
  const ZONE   = document.getElementById("zone");
  const PROG   = document.getElementById("prog");
  const TOTAL  = document.getElementById("total");
  const STATUS = document.getElementById("status");
  const TRAY = document.getElementById("tray");

  const BTN_SHUFFLE = document.getElementById("shuffle");
  const BTN_RESET   = document.getElementById("reset");
  const BTN_NEXT    = document.getElementById("next");
  const BTN_HINT    = document.getElementById("hintBtn");

  const SNAP_DISTANCE = 35;

  const norm = (s) => (s||"")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ")
    .trim();

  function colorFor(code){
    let h = 0;
    for (let i=0;i<code.length;i++) h = (h*31 + code.charCodeAt(i)) >>> 0;
    const hue = h % 360;
    return `hsl(${hue} 70% 60%)`;
  }

  const CODE_TO_NAME = {
    "ES-C":"A Coru√±a","ES-LU":"Lugo","ES-OR":"Ourense","ES-PO":"Pontevedra",
    "ES-O":"Asturias","ES-S":"Cantabria",
    "ES-BI":"Bizkaia","ES-SS":"Gipuzkoa","ES-VI":"√Ålava",
    "ES-NA":"Navarra","ES-RI":"La Rioja",
    "ES-HU":"Huesca","ES-TE":"Teruel","ES-Z":"Zaragoza",
    "ES-B":"Barcelona","ES-GI":"Girona","ES-L":"Lleida","ES-T":"Tarragona",
    "ES-LE":"Le√≥n","ES-ZA":"Zamora","ES-SA":"Salamanca","ES-AV":"√Åvila","ES-SG":"Segovia","ES-VA":"Valladolid","ES-BU":"Burgos","ES-SO":"Soria","ES-P":"Palencia",
    "ES-CU":"Cuenca","ES-GU":"Guadalajara","ES-TO":"Toledo","ES-CR":"Ciudad Real","ES-AB":"Albacete",
    "ES-CC":"C√°ceres","ES-BA":"Badajoz",
    "ES-M":"Madrid",
    "ES-CS":"Castell√≥n","ES-V":"Valencia","ES-A":"Alicante",
    "ES-MU":"Murcia",
    "ES-AL":"Almer√≠a","ES-CA":"C√°diz","ES-CO":"C√≥rdoba","ES-GR":"Granada","ES-H":"Huelva","ES-J":"Ja√©n","ES-MA":"M√°laga","ES-SE":"Sevilla",
    "ES-IB":"Illes Balears",
    "ES-GC":"Las Palmas","ES-TF":"Santa Cruz de Tenerife",
    "ES-CE":"Ceuta","ES-ML":"Melilla"
  };

  const PROV_TO_CC = new Map([
    ["a coruna","Galicia"],["lugo","Galicia"],["ourense","Galicia"],["pontevedra","Galicia"],
    ["asturias","Principado de Asturias"],["cantabria","Cantabria"],
    ["alava","Pa√≠s Vasco"],["gipuzkoa","Pa√≠s Vasco"],["bizkaia","Pa√≠s Vasco"],
    ["navarra","Navarra"],["la rioja","La Rioja"],
    ["huesca","Arag√≥n"],["teruel","Arag√≥n"],["zaragoza","Arag√≥n"],
    ["barcelona","Catalu√±a"],["girona","Catalu√±a"],["lleida","Catalu√±a"],["tarragona","Catalu√±a"],
    ["avila","Castilla y Le√≥n"],["burgos","Castilla y Le√≥n"],["leon","Castilla y Le√≥n"],["palencia","Castilla y Le√≥n"],["salamanca","Castilla y Le√≥n"],
    ["segovia","Castilla y Le√≥n"],["soria","Castilla y Le√≥n"],["valladolid","Castilla y Le√≥n"],["zamora","Castilla y Le√≥n"],
    ["madrid","Comunidad de Madrid"],
    ["albacete","Castilla-La Mancha"],["ciudad real","Castilla-La Mancha"],["cuenca","Castilla-La Mancha"],["guadalajara","Castilla-La Mancha"],["toledo","Castilla-La Mancha"],
    ["caceres","Extremadura"],["badajoz","Extremadura"],
    ["alicante","Comunidad Valenciana"],["castellon","Comunidad Valenciana"],["valencia","Comunidad Valenciana"],
    ["murcia","Regi√≥n de Murcia"],
    ["almeria","Andaluc√≠a"],["cadiz","Andaluc√≠a"],["cordoba","Andaluc√≠a"],["granada","Andaluc√≠a"],["huelva","Andaluc√≠a"],["jaen","Andaluc√≠a"],["malaga","Andaluc√≠a"],["sevilla","Andaluc√≠a"],
    ["illes balears","Illes Balears"],
    ["las palmas","Canarias"],["santa cruz de tenerife","Canarias"],
    ["ceuta","Ceuta"],["melilla","Melilla"]
  ]);

  const LEVELS = [
    "Galicia","Principado de Asturias","Cantabria","Pa√≠s Vasco","Navarra","La Rioja",
    "Arag√≥n","Catalu√±a","Castilla y Le√≥n","Comunidad de Madrid","Castilla-La Mancha",
    "Extremadura","Comunidad Valenciana","Regi√≥n de Murcia","Andaluc√≠a",
    "Illes Balears","Canarias","Ceuta","Melilla"
  ];

  function getNameFromSvg(el){
    const t = el.querySelector?.("title")?.textContent?.trim();
    if(t) return t;
    const aria = el.getAttribute?.("aria-label")?.trim();
    if(aria) return aria;
    const label = el.getAttribute?.("inkscape:label")?.trim();
    if(label) return label;
    return "";
  }

  // ===== Cargar SVG =====
  let svgText="";
  try{
    const res = await fetch("./spain-provinces.svg");
    if(!res.ok) throw "";
    svgText = await res.text();
  }catch{
    LOADING?.remove();
    STAGE.innerHTML = `<div class="bad">No puedo cargar <code>spain-provinces.svg</code></div>`;
    return;
  }

  LOADING?.remove();
  STAGE.insertAdjacentHTML("beforeend", svgText);

  const svg = STAGE.querySelector("svg");
  if(!svg){ STAGE.innerHTML="<div class='bad'>SVG inv√°lido</div>"; return; }

  // eliminar textos del svg original
  svg.querySelectorAll("text").forEach(t => t.remove());
  svg.querySelectorAll('[class*="label"],[id*="label"]').forEach(el => el.remove());

  // Detectar provincias ES-XX
  let raw = Array.from(svg.querySelectorAll('g[id^="ES-"]'));
  if(!raw.length) raw = Array.from(svg.querySelectorAll('path[id^="ES-"]'));
  if(!raw.length){ STATUS.innerHTML=`<span class="bad">No encuentro ids ES-XX</span>`; return; }

  const catalog = raw.map(el => {
    const code = el.id;
    const name = getNameFromSvg(el) || CODE_TO_NAME[code] || code;
    const cc = PROV_TO_CC.get(norm(name)) || "OTRAS";
    return { code, name, cc, node: el };
  }).filter(p => p.cc !== "OTRAS");

  STATUS.innerHTML = `<span class="ok">Provincias detectadas: ${catalog.length}</span>`;

  // Capas
  const baseMap   = document.createElementNS("http://www.w3.org/2000/svg","g");
  const slotsLayer= document.createElementNS("http://www.w3.org/2000/svg","g");
  const placedLayer= document.createElementNS("http://www.w3.org/2000/svg","g");
  const provLabels= document.createElementNS("http://www.w3.org/2000/svg","g");
  const ccLabels  = document.createElementNS("http://www.w3.org/2000/svg","g");

  svg.innerHTML = "";
  svg.append(baseMap, slotsLayer, placedLayer, provLabels, ccLabels);

  // Base mapa coloreado
  const baseByCode = new Map();
  for(const p of catalog){
    const shape = p.node.cloneNode(true);
    shape.removeAttribute("id");
    shape.setAttribute("data-province", p.code);
    shape.setAttribute("fill", colorFor(p.code));
    shape.setAttribute("opacity", "0.35");
    shape.setAttribute("stroke", "#ffffff");
    shape.setAttribute("stroke-width", "1");
    shape.setAttribute("vector-effect","non-scaling-stroke");
    baseMap.appendChild(shape);
    baseByCode.set(p.code, shape);
  }

  // Helpers bbox labels
  await new Promise(requestAnimationFrame);

  function buildProvinceLabels(){
    provLabels.innerHTML = "";
    for(const p of catalog){
      const base = baseByCode.get(p.code);
      if(!base) continue;
      const b = base.getBBox();
      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("class","prov-label");
      t.setAttribute("x", b.x + b.width/2);
      t.setAttribute("y", b.y + b.height/2);
      t.setAttribute("text-anchor","middle");
      t.setAttribute("dominant-baseline","middle");
      t.textContent = p.name;
      provLabels.appendChild(t);
    }
  }

  function buildCCLabels(){
    ccLabels.innerHTML = "";
    const byCC = new Map();
    for(const p of catalog){
      if(!byCC.has(p.cc)) byCC.set(p.cc, []);
      byCC.get(p.cc).push(p);
    }
    for(const [ccName, arr] of byCC.entries()){
      let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
      for(const p of arr){
        const base = baseByCode.get(p.code);
        if(!base) continue;
        const b = base.getBBox();
        minX=Math.min(minX,b.x); minY=Math.min(minY,b.y);
        maxX=Math.max(maxX,b.x+b.width); maxY=Math.max(maxY,b.y+b.height);
      }
      if(!isFinite(minX)) continue;
      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("class","cc-label");
      t.setAttribute("x",(minX+maxX)/2);
      t.setAttribute("y",(minY+maxY)/2);
      t.setAttribute("text-anchor","middle");
      t.setAttribute("dominant-baseline","middle");
      t.textContent = ccName;
      ccLabels.appendChild(t);
    }
  }

  buildProvinceLabels();
  buildCCLabels();

  // ===== Juego =====
  let levelIndex = 0;
  let placed = new Set();
  let activeList = [];

  let pieceElByCode = new Map();
  let slotElByCode = new Map();

  function clearHints(){
    slotsLayer.querySelectorAll(".slot.hint").forEach(s => s.classList.remove("hint"));
  }

  function randomPendingCode(){
    const pending = activeList.filter(p => !placed.has(p.code));
    if(!pending.length) return null;
    return pending[Math.floor(Math.random()*pending.length)].code;
  }

  function renderLevel(){
    placed = new Set();
    activeList = [];
    pieceElByCode.clear();
    slotElByCode.clear();

    slotsLayer.innerHTML = "";
    placedLayer.innerHTML = "";
    TRAY.innerHTML = "";
    clearHints();

    const cc = LEVELS[levelIndex];
    ZONE.textContent = cc;

    activeList = catalog.filter(p => p.cc === cc);
    TOTAL.textContent = String(activeList.length);
    PROG.textContent = "0";

    for(const p of activeList){
      const slot = p.node.cloneNode(true);
      slot.removeAttribute("id");
      slot.setAttribute("class","slot");
      slot.setAttribute("data-province", p.code);
      slotsLayer.appendChild(slot);
      slotElByCode.set(p.code, slot);

      const box = document.createElement("div");
      box.className="pieceBox";
      box.setAttribute("data-code", p.code);

      const name = document.createElement("div");
      name.className="pieceName";
      name.textContent = p.name;
      box.appendChild(name);

      const mini = document.createElement("div");
      mini.className="mini";
      mini.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg"></svg>`;
      const miniSvg = mini.querySelector("svg");

      const piece = p.node.cloneNode(true);
      piece.removeAttribute("id");
      piece.setAttribute("data-province", p.code);
      piece.setAttribute("fill", colorFor(p.code));
      piece.setAttribute("stroke", "#111827");
      piece.setAttribute("stroke-width", "1");
      piece.setAttribute("vector-effect","non-scaling-stroke");
      piece.classList.add("placedGlow");
      miniSvg.appendChild(piece);

      const b = piece.getBBox();
      const m = Math.max(b.width,b.height)*0.15;
      miniSvg.setAttribute("viewBox", `${b.x-m} ${b.y-m} ${b.width+2*m} ${b.height+2*m}`);
      miniSvg.setAttribute("preserveAspectRatio", "xMidYMid meet");

      box.appendChild(mini);
      TRAY.appendChild(box);

      box.addEventListener("pointerdown", (ev) => {
        ev.preventDefault();
        if(placed.has(p.code)) return;
        startDragFromTray(p.code, ev);
      });
    }
  }

  // Dragging pieza en SVG principal
  let dragging = null;
  let draggingCode = null;
  let startPt = null;
  let startTr = {x:0,y:0};

  const svgPoint = (evt) => {
    const p = svg.createSVGPoint();
    p.x = evt.clientX; p.y = evt.clientY;
    return p.matrixTransform(svg.getScreenCTM().inverse());
  };
  const parseTranslate = (el) => {
    const t = el.getAttribute("transform") || "translate(0,0)";
    const m = /translate\(([-\d.]+)[ ,]([-\d.]+)\)/.exec(t);
    return { x: m?+m[1]:0, y: m?+m[2]:0 };
  };
  const setTranslate = (el,x,y) => el.setAttribute("transform", `translate(${x},${y})`);
  const centerOf = (el) => {
    const b = el.getBBox();
    return { x: b.x + b.width/2, y: b.y + b.height/2, box: b };
  };

  function startDragFromTray(code, ev){
    let piece = pieceElByCode.get(code);
    if(!piece){
      const p = activeList.find(x=>x.code===code);
      piece = p.node.cloneNode(true);
      piece.removeAttribute("id");
      piece.setAttribute("data-province", code);
      piece.setAttribute("fill", colorFor(code));
      piece.setAttribute("stroke","#111827");
      piece.setAttribute("stroke-width","1.1");
      piece.setAttribute("vector-effect","non-scaling-stroke");
      piece.classList.add("placedGlow");
      svg.appendChild(piece);
      pieceElByCode.set(code, piece);

      const sp = svgPoint(ev);
      const b = piece.getBBox();
      setTranslate(piece, sp.x - (b.x + b.width/2), sp.y - (b.y + b.height/2));
    }

    dragging = piece;
    draggingCode = code;
    startPt = svgPoint(ev);
    startTr = parseTranslate(dragging);
    dragging.setPointerCapture?.(ev.pointerId);
  }

  function trySnap(piece, code){
    const slot = slotElByCode.get(code);
    if(!slot) return false;

    const pc = centerOf(piece);
    const sc = centerOf(slot);
    const dist = Math.hypot(pc.x - sc.x, pc.y - sc.y);
    if(dist > SNAP_DISTANCE) return false;

    const dx = sc.box.x - pc.box.x;
    const dy = sc.box.y - pc.box.y;
    setTranslate(piece, dx, dy);

    placedLayer.appendChild(piece);
    placed.add(code);
    PROG.textContent = String(placed.size);

    const base = baseByCode.get(code);
    if(base) base.setAttribute("opacity","0.12");

    const box = TRAY.querySelector(`.pieceBox[data-code="${code}"]`);
    if(box){
      box.style.opacity="0.55";
      box.style.filter="grayscale(0.2)";
      const label = box.querySelector(".pieceName");
      if(label) label.textContent = "‚úÖ " + label.textContent.replace(/^‚úÖ\s*/,"");
    }

    clearHints();
    if(placed.size === activeList.length){
      setTimeout(()=>{ alert(`¬°${ZONE.textContent} completada! üéâ`); nextLevel(); }, 80);
    }
    return true;
  }

  svg.addEventListener("pointermove", (e) => {
    if(!dragging) return;
    const p = svgPoint(e);
    setTranslate(dragging, startTr.x + (p.x - startPt.x), startTr.y + (p.y - startPt.y));
  });

  window.addEventListener("pointerup", () => {
    if(!dragging) return;
    const ok = trySnap(dragging, draggingCode);
    // si no encaja, la dejamos donde est√° (m√°s natural en modo libre)
    dragging = null;
    draggingCode = null;
  });

  BTN_HINT.onclick = () => {
    clearHints();
    const code = randomPendingCode();
    if(!code) return;
    const slot = slotElByCode.get(code);
    if(slot) slot.classList.add("hint");
  };

  BTN_SHUFFLE.onclick = () => {
    const items = Array.from(TRAY.children);
    for(let i=items.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      TRAY.insertBefore(items[j], items[i]);
    }
  };

  BTN_RESET.onclick = () => {
    for(const p of activeList){
      const base = baseByCode.get(p.code);
      if(base) base.setAttribute("opacity","0.35");
    }
    renderLevel();
  };

  function nextLevel(){
    levelIndex++;
    if(levelIndex >= LEVELS.length){
      alert("¬°Espa√±a completada! üá™üá∏");
      levelIndex = 0;
      for(const p of catalog){
        const base = baseByCode.get(p.code);
        if(base) base.setAttribute("opacity","0.35");
      }
    }
    renderLevel();
  }
  BTN_NEXT.onclick = nextLevel;

  // Start
  renderLevel();
})();
</script>
</body>
</html>
