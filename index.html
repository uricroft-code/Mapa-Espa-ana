<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa de Espa√±a ‚Äî Puzzle por Provincias</title>

  <style>
    body{margin:0;background:#f5f7ff;font-family:system-ui,sans-serif;display:flex;justify-content:center}
    .wrap{width:min(1280px,96vw);padding:16px}
    header{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:8px 12px;font-weight:700}
    button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:800}
    .btn1{background:#f97316;color:#fff}
    .btn2{background:#ef4444;color:#fff}
    .btn3{background:#10b981;color:#fff}

    .grid{display:grid;grid-template-columns: 1.35fr .65fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:12px}
    #stage{width:100%;height:min(78vh,760px);border-radius:16px;overflow:hidden}
    #stage svg{width:100%;height:100%;display:block}

    .slot{
      fill:#f1f5f9;
      stroke:#94a3b8;
      stroke-width:1;
      stroke-dasharray:6 6;
      vector-effect: non-scaling-stroke;
      pointer-events:none;
    }
    .piece{
      fill:#60a5fa;
      stroke:#1e40af;
      stroke-width:1;
      vector-effect: non-scaling-stroke;
      cursor:grab;
      transition:transform .12s ease;
    }
    .piece.dragging{cursor:grabbing;opacity:.85}
    .piece.placed{pointer-events:none;filter: drop-shadow(0 3px 8px rgba(0,0,0,.18))}

    .hint{color:#374151;margin-top:10px;line-height:1.4}
    .list{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;max-height:55vh;overflow:auto;padding-right:6px}
    .chip{
      border:1px solid #bfdbfe;
      background:#eff6ff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      white-space:nowrap;
    }
    .ok{color:#16a34a;font-weight:800}
    .bad{color:#dc2626;font-weight:800}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="pill">Zona: <span id="zone">‚Äî</span></div>
      <div class="pill">Progreso: <span id="prog">0</span>/<span id="total">0</span></div>
      <button class="btn1" id="shuffle">Ordenar piezas</button>
      <button class="btn2" id="reset">Reiniciar zona</button>
      <button class="btn3" id="skip" title="Pasa a la siguiente comunidad">Siguiente</button>
    </header>

    <div class="grid">
      <div class="card" id="stage">
        <div id="loading" class="hint">Cargando mapa real‚Ä¶</div>
      </div>

      <div class="card">
        <b>Piezas disponibles</b>
        <div id="status" class="hint"></div>
        <div class="list" id="chips"></div>
        <div class="hint">
          Consejo: si cuesta encajar, sube <code>SNAP_DISTANCE</code>.
        </div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const STAGE = document.getElementById("stage");
  const LOADING = document.getElementById("loading");
  const ZONE = document.getElementById("zone");
  const PROG = document.getElementById("prog");
  const TOTAL = document.getElementById("total");
  const CHIPS = document.getElementById("chips");
  const STATUS = document.getElementById("status");

  const BTN_SHUFFLE = document.getElementById("shuffle");
  const BTN_RESET = document.getElementById("reset");
  const BTN_SKIP = document.getElementById("skip");

  const SNAP_DISTANCE = 35;

  // ============ Helpers ============
  const norm = (s) => (s || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g," ")
    .trim();

  // Intentar sacar nombre humano del SVG (title/label)
  function getHumanName(el){
    const t = el.querySelector?.("title")?.textContent?.trim();
    if (t) return t;
    const aria = el.getAttribute?.("aria-label")?.trim();
    if (aria) return aria;
    const label = el.getAttribute?.("inkscape:label")?.trim();
    if (label) return label;
    return "";
  }

  // C√≥digos -> nombres (fallback si el SVG no trae title)
  const CODE_TO_NAME = {
    "ES-C":"A Coru√±a","ES-LU":"Lugo","ES-OR":"Ourense","ES-PO":"Pontevedra",
    "ES-O":"Asturias","ES-S":"Cantabria",
    "ES-BI":"Bizkaia","ES-SS":"Gipuzkoa","ES-VI":"√Ålava",
    "ES-NA":"Navarra","ES-RI":"La Rioja",
    "ES-HU":"Huesca","ES-TE":"Teruel","ES-Z":"Zaragoza",
    "ES-B":"Barcelona","ES-GI":"Girona","ES-L":"Lleida","ES-T":"Tarragona",
    "ES-LE":"Le√≥n","ES-ZA":"Zamora","ES-SA":"Salamanca","ES-AV":"√Åvila","ES-SG":"Segovia","ES-VA":"Valladolid","ES-BU":"Burgos","ES-SO":"Soria","ES-P":"Palencia",
    "ES-CU":"Cuenca","ES-GU":"Guadalajara","ES-TO":"Toledo","ES-CR":"Ciudad Real","ES-AB":"Albacete",
    "ES-CC":"C√°ceres","ES-BA":"Badajoz",
    "ES-M":"Madrid",
    "ES-CS":"Castell√≥n","ES-V":"Valencia","ES-A":"Alicante",
    "ES-MU":"Murcia",
    "ES-AL":"Almer√≠a","ES-CA":"C√°diz","ES-CO":"C√≥rdoba","ES-GR":"Granada","ES-H":"Huelva","ES-J":"Ja√©n","ES-MA":"M√°laga","ES-SE":"Sevilla",
    "ES-IB":"Illes Balears",
    "ES-GC":"Las Palmas","ES-TF":"Santa Cruz de Tenerife",
    "ES-CE":"Ceuta","ES-ML":"Melilla"
  };

  // Provincia (nombre) -> Comunidad (para niveles)
  // (usamos nombres normalizados, as√≠ da igual si viene con acentos)
  const PROV_TO_CC = new Map([
    // Galicia
    ["a coruna","Galicia"],["la coruna","Galicia"],["coruna","Galicia"],["lugo","Galicia"],["ourense","Galicia"],["orense","Galicia"],["pontevedra","Galicia"],
    // Asturias / Cantabria
    ["asturias","Principado de Asturias"],["cantabria","Cantabria"],
    // Pa√≠s Vasco
    ["alava","Pa√≠s Vasco"],["araba","Pa√≠s Vasco"],["gipuzkoa","Pa√≠s Vasco"],["guipuzcoa","Pa√≠s Vasco"],["bizkaia","Pa√≠s Vasco"],["vizcaya","Pa√≠s Vasco"],
    // Navarra / La Rioja
    ["navarra","Navarra"],["la rioja","La Rioja"],["rioja","La Rioja"],
    // Arag√≥n
    ["huesca","Arag√≥n"],["teruel","Arag√≥n"],["zaragoza","Arag√≥n"],
    // Catalu√±a
    ["barcelona","Catalu√±a"],["girona","Catalu√±a"],["gerona","Catalu√±a"],["lleida","Catalu√±a"],["lerida","Catalu√±a"],["tarragona","Catalu√±a"],
    // Castilla y Le√≥n
    ["avila","Castilla y Le√≥n"],["burgos","Castilla y Le√≥n"],["leon","Castilla y Le√≥n"],["palencia","Castilla y Le√≥n"],["salamanca","Castilla y Le√≥n"],
    ["segovia","Castilla y Le√≥n"],["soria","Castilla y Le√≥n"],["valladolid","Castilla y Le√≥n"],["zamora","Castilla y Le√≥n"],
    // Madrid
    ["madrid","Comunidad de Madrid"],
    // Castilla-La Mancha
    ["albacete","Castilla-La Mancha"],["ciudad real","Castilla-La Mancha"],["cuenca","Castilla-La Mancha"],["guadalajara","Castilla-La Mancha"],["toledo","Castilla-La Mancha"],
    // Extremadura
    ["caceres","Extremadura"],["badajoz","Extremadura"],
    // Comunidad Valenciana
    ["alicante","Comunidad Valenciana"],["alacant","Comunidad Valenciana"],["castellon","Comunidad Valenciana"],["castello","Comunidad Valenciana"],["valencia","Comunidad Valenciana"],
    // Murcia
    ["murcia","Regi√≥n de Murcia"],
    // Andaluc√≠a
    ["almeria","Andaluc√≠a"],["cadiz","Andaluc√≠a"],["cordoba","Andaluc√≠a"],["granada","Andaluc√≠a"],["huelva","Andaluc√≠a"],["jaen","Andaluc√≠a"],["malaga","Andaluc√≠a"],["sevilla","Andaluc√≠a"],
    // Baleares / Canarias
    ["illes balears","Illes Balears"],["baleares","Illes Balears"],
    ["las palmas","Canarias"],["santa cruz de tenerife","Canarias"],["tenerife","Canarias"],
    // Ceuta / Melilla
    ["ceuta","Ceuta"],["melilla","Melilla"]
  ]);

  // Orden de niveles (como quer√≠as, norte primero)
  const LEVELS = [
    { cc: "Galicia" },
    { cc: "Principado de Asturias" },
    { cc: "Cantabria" },
    { cc: "Pa√≠s Vasco" },
    { cc: "Navarra" },
    { cc: "La Rioja" },
    { cc: "Arag√≥n" },
    { cc: "Catalu√±a" },
    { cc: "Castilla y Le√≥n" },
    { cc: "Comunidad de Madrid" },
    { cc: "Castilla-La Mancha" },
    { cc: "Extremadura" },
    { cc: "Comunidad Valenciana" },
    { cc: "Regi√≥n de Murcia" },
    { cc: "Andaluc√≠a" },
    { cc: "Illes Balears" },
    { cc: "Canarias" },
    { cc: "Ceuta" },
    { cc: "Melilla" }
  ];

  // ============ Cargar SVG ============
  let svgText = "";
  try{
    const res = await fetch("./spain-provinces.svg");
    if(!res.ok) throw "";
    svgText = await res.text();
  }catch{
    LOADING?.remove();
    STAGE.innerHTML = `
      <div class="bad">No puedo cargar <code>spain-provinces.svg</code></div>
      <div class="hint">Aseg√∫rate de que existe en el repo y se llama EXACTAMENTE as√≠.</div>`;
    return;
  }

  LOADING?.remove();
  STAGE.insertAdjacentHTML("beforeend", svgText);

  const svg = STAGE.querySelector("svg");
  if(!svg){
    STAGE.innerHTML = "<div class='bad'>SVG inv√°lido</div>";
    return;
  }

  // LIMPIEZA: quita nombres azules del SVG
  svg.querySelectorAll("text").forEach(t => t.remove());
  svg.querySelectorAll('[class*="label"],[id*="label"]').forEach(el => el.remove());

  if(!svg.getAttribute("viewBox")){
    const w = svg.getAttribute("width") || 1000;
    const h = svg.getAttribute("height") || 1000;
    svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
  }

  // Detectar candidatos por id ES-...
  let candidates = Array.from(svg.querySelectorAll('g[id^="ES-"]'));
  if(!candidates.length) candidates = Array.from(svg.querySelectorAll('path[id^="ES-"]'));

  if(!candidates.length){
    STATUS.innerHTML = `<span class="bad">No encuentro provincias con ids ES-XX en tu SVG</span>`;
    return;
  }

  // Construir cat√°logo de provincias: code -> {el, name, cc}
  const catalog = new Map();

  for (const el of candidates) {
    const code = el.id;
    if (!code) continue;

    // Nombre humano: del SVG o fallback por c√≥digo
    const fromSvg = getHumanName(el);
    const name = fromSvg || CODE_TO_NAME[code] || code;

    // Comunidad: por nombre (normalizado)
    const cc = PROV_TO_CC.get(norm(name)) || "OTRAS";

    catalog.set(code, { code, el, name, cc });
  }

  // Filtrar ‚Äúcosas raras‚Äù del SVG:
  // nos quedamos solo con provincias con cc conocida (no OTRAS)
  const known = Array.from(catalog.values()).filter(p => p.cc !== "OTRAS");

  if(!known.length){
    STATUS.innerHTML = `<span class="bad">He detectado ES-XX pero no puedo asignarlos a comunidades</span>`;
    return;
  }

  STATUS.innerHTML = `<span class="ok">SVG OK</span> ¬∑ Provincias √∫tiles: <b>${known.length}</b>`;

  // Preparar SVG para juego
  const board = document.createElementNS("http://www.w3.org/2000/svg","g");
  const pieces = document.createElementNS("http://www.w3.org/2000/svg","g");
  board.setAttribute("id","board");
  pieces.setAttribute("id","pieces");
  svg.innerHTML = "";
  svg.append(board, pieces);

  // Estado de nivel
  let levelIndex = 0;
  let active = null;
  let activePlaced = new Set();
  let activeList = [];

  // ============ Render nivel ============
  function renderLevel(){
    activePlaced = new Set();
    board.innerHTML = "";
    pieces.innerHTML = "";
    CHIPS.innerHTML = "";

    const levelCC = LEVELS[levelIndex]?.cc || "Espa√±a (provincias)";
    ZONE.textContent = levelCC;

    activeList = known.filter(p => p.cc === levelCC);

    // Si alguna comunidad est√° vac√≠a (por SVG raro), saltamos sola
    if(activeList.length === 0){
      nextLevel();
      return;
    }

    TOTAL.textContent = String(activeList.length);
    PROG.textContent = "0";

    // Crear slots + piezas
    for (const p of activeList) {
      const slot = p.el.cloneNode(true);
      slot.removeAttribute("id");
      slot.setAttribute("class","slot");
      slot.setAttribute("data-province", p.code);
      board.appendChild(slot);

      const piece = p.el.cloneNode(true);
      piece.removeAttribute("id");
      piece.setAttribute("class","piece");
      piece.setAttribute("data-province", p.code);
      piece.setAttribute("data-name", p.name);
      pieces.appendChild(piece);

      // Chip con nombre bonito
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = p.name;
      CHIPS.appendChild(chip);
    }

    shufflePieces();
  }

  // Ordenar piezas (rejilla a la izquierda)
  function shufflePieces(){
    const els = Array.from(pieces.querySelectorAll(".piece"))
      .filter(el => !el.classList.contains("placed"));

    const cols = 2;
    const gapX = 120, gapY = 80;
    const startX = 20, startY = 20;

    els.forEach((el, i) => {
      const b = el.getBBox();
      const x = startX + (i%cols)*gapX - b.x;
      const y = startY + Math.floor(i/cols)*gapY - b.y;
      el.setAttribute("transform", `translate(${x},${y})`);
    });
  }

  // Drag helpers
  const svgPoint = (evt) => {
    const p = svg.createSVGPoint();
    p.x = evt.clientX; p.y = evt.clientY;
    return p.matrixTransform(svg.getScreenCTM().inverse());
  };

  const parseTranslate = (el) => {
    const t = el.getAttribute("transform") || "translate(0,0)";
    const m = /translate\(([-\d.]+)[ ,]([-\d.]+)\)/.exec(t);
    return { x: m?+m[1]:0, y: m?+m[2]:0 };
  };

  const setTranslate = (el,x,y) => el.setAttribute("transform", `translate(${x},${y})`);

  const centerOf = (el) => {
    const b = el.getBBox();
    return { x: b.x + b.width/2, y: b.y + b.height/2, box: b };
  };

  function trySnap(piece){
    const code = piece.getAttribute("data-province");
    const slot = board.querySelector(`.slot[data-province="${code}"]`);
    if(!slot) return false;

    const pc = centerOf(piece);
    const sc = centerOf(slot);

    const dist = Math.hypot(pc.x - sc.x, pc.y - sc.y);
    if(dist > SNAP_DISTANCE) return false;

    // Alinear caja
    const dx = sc.box.x - pc.box.x;
    const dy = sc.box.y - pc.box.y;
    setTranslate(piece, dx, dy);

    piece.classList.add("placed");
    activePlaced.add(code);
    PROG.textContent = String(activePlaced.size);

    // ¬ønivel completado?
    if(activePlaced.size === activeList.length){
      setTimeout(() => {
        alert(`¬°${ZONE.textContent} completada! üéâ`);
        nextLevel();
      }, 50);
    }
    return true;
  }

  // Drag
  let dragging = null;
  let startPt = null;
  let startTr = {x:0,y:0};

  svg.addEventListener("pointerdown", (e) => {
    const target = e.target.closest?.(".piece");
    if(!target || target.classList.contains("placed")) return;

    dragging = target;
    dragging.classList.add("dragging");
    pieces.appendChild(dragging); // al frente

    startPt = svgPoint(e);
    startTr = parseTranslate(dragging);
    dragging.setPointerCapture?.(e.pointerId);
  });

  window.addEventListener("pointermove", (e) => {
    if(!dragging) return;
    const p = svgPoint(e);
    setTranslate(dragging, startTr.x + (p.x - startPt.x), startTr.y + (p.y - startPt.y));
  });

  window.addEventListener("pointerup", () => {
    if(!dragging) return;
    dragging.classList.remove("dragging");

    const ok = trySnap(dragging);
    if(!ok){
      // vuelve a la rejilla (sin castigar)
      dragging.setAttribute("transform", "translate(0,0)");
      shufflePieces();
    }

    dragging = null;
  });

  // Botones
  BTN_SHUFFLE.onclick = shufflePieces;

  BTN_RESET.onclick = () => {
    // Reiniciar SOLO nivel actual
    renderLevel();
  };

  function nextLevel(){
    levelIndex++;
    if(levelIndex >= LEVELS.length){
      alert("¬°Espa√±a completada! üá™üá∏");
      levelIndex = 0; // vuelve a empezar
    }
    renderLevel();
  }

  BTN_SKIP.onclick = nextLevel;

  // Start
  renderLevel();
})();
</script>
</body>
</html>
