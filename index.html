import React, { useState } from 'react';
import { motion } from 'framer-motion';
import { Undo2, Trophy, Map as MapIcon } from 'lucide-react';

// --- DATOS DE EJEMPLO (Aquí añadirías las 50 provincias) ---
// El 'path' es la forma real. 'x' e 'y' es su posición correcta en el mapa.
const PROVINCIAS_DATA = [
  { id: 'madrid', nombre: 'Madrid', color: '#fbbf24', x: 205, y: 165, path: "M 25.5 12.4 L 29.2 16.5 L 27.5 22.4 L 21.2 24.5 L 16.5 20.2 L 18.2 14.5 Z" },
  { id: 'barcelona', nombre: 'Barcelona', color: '#f87171', x: 410, y: 110, path: "M 15.2 5.5 L 22.1 8.2 L 25.5 15.5 L 20.2 22.1 L 12.5 18.2 L 10.5 10.2 Z" },
  { id: 'sevilla', nombre: 'Sevilla', color: '#60a5fa', x: 140, y: 280, path: "M 10.2 15.5 L 18.5 10.2 L 28.2 15.5 L 25.5 25.5 L 15.2 28.2 L 8.2 20.2 Z" },
  { id: 'a_coruna', nombre: 'A Coruña', color: '#34d399', x: 45, y: 45, path: "M 5.5 5.5 L 15.2 2.2 L 22.1 8.2 L 18.2 18.2 L 8.2 15.2 L 2.2 10.2 Z" },
];

export default function SpainPuzzle() {
  const [piezasSueltas, setPiezasSueltas] = useState(
    PROVINCIAS_DATA.map(p => ({
      ...p,
      currentX: 500 + Math.random() * 200, // Dispersas a la derecha
      currentY: 50 + Math.random() * 300,
      encajada: false
    }))
  );
  
  const [puntos, setPuntos] = useState(0);
  const [nivel, setNivel] = useState(2);

  const handleDragEnd = (id, info) => {
    const pieza = piezasSueltas.find(p => p.id === id);
    const dropX = pieza.currentX + info.offset.x;
    const dropY = pieza.currentY + info.offset.y;

    // Distancia entre donde soltamos y el hueco real
    const distancia = Math.sqrt(
      Math.pow(dropX - pieza.x, 2) + Math.pow(dropY - pieza.y, 2)
    );

    // Si está a menos de 30px, encaja automáticamente
    if (distancia < 30) {
      setPiezasSueltas(prev => prev.map(p => 
        p.id === id ? { ...p, encajada: true, currentX: pieza.x, currentY: pieza.y } : p
      ));
      setPuntos(prev => prev + 10);
    }
  };

  const reiniciar = () => {
    setPiezasSueltas(prev => prev.map(p => ({
      ...p,
      encajada: false,
      currentX: 500 + Math.random() * 200,
      currentY: 50 + Math.random() * 300
    })));
    setPuntos(0);
  };

  return (
    <div className="min-h-screen bg-slate-200 p-8 flex flex-col items-center font-sans">
      
      {/* Título y Marcador */}
      <div className="w-full max-w-6xl flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-md border-b-4 border-slate-300">
        <h1 className="text-2xl font-black text-slate-700 flex items-center gap-2">
          <MapIcon /> Provincias de España (Puzzle Real)
        </h1>
        <div className="flex gap-4 items-center">
          <div className="bg-green-700 text-white px-4 py-2 rounded-lg font-bold">
            Puntos: {puntos} / {PROVINCIAS_DATA.length * 10}
          </div>
          <button onClick={reiniciar} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
            <Undo2 className="text-slate-600" />
          </button>
        </div>
      </div>

      <div className="relative w-full max-w-6xl h-[600px] bg-white rounded-3xl shadow-2xl border-8 border-slate-300 overflow-hidden flex">
        
        {/* LADO IZQUIERDO: EL MAPA GUÍA */}
        <div className="flex-1 relative bg-slate-50 border-r border-slate-100">
          <svg viewBox="0 0 500 450" className="w-full h-full">
            {/* Dibujamos los huecos vacíos (Siluetas) */}
            {PROVINCIAS_DATA.map(p => (
              <path
                key={`slot-${p.id}`}
                d={p.path}
                transform={`translate(${p.x}, ${p.y})`}
                className="fill-slate-200 stroke-slate-300 stroke-1"
              />
            ))}
            
            {/* Dibujamos las piezas que YA han encajado */}
            {piezasSueltas.filter(p => p.encajada).map(p => (
              <motion.path
                initial={{ opacity: 0, scale: 1.5 }}
                animate={{ opacity: 1, scale: 1 }}
                key={`fixed-${p.id}`}
                d={p.path}
                transform={`translate(${p.x}, ${p.y})`}
                fill={p.color}
                className="stroke-white stroke-1"
              />
            ))}
          </svg>

          {/* Recuadro de Canarias (Estilo Enrique Alonso) */}
          <div className="absolute bottom-4 left-4 w-40 h-24 border-2 border-red-400 bg-white/50 rounded-lg flex items-center justify-center text-[10px] text-red-400 font-bold uppercase">
            Canarias
          </div>
        </div>

        {/* LADO DERECHO: ÁREA DE PIEZAS SUELTAS */}
        <div className="w-80 bg-slate-100 p-4 relative overflow-y-auto">
          <div className="text-center text-xs font-bold text-slate-400 mb-4 uppercase tracking-widest">
            Arrastra las piezas al mapa
          </div>
          
          {/* Piezas móviles */}
          {piezasSueltas.filter(p => !p.encajada).map(p => (
            <motion.div
              key={`piece-${p.id}`}
              drag
              dragMomentum={false}
              onDragEnd={(_, info) => handleDragEnd(p.id, info)}
              className="absolute cursor-grab active:cursor-grabbing z-50"
              style={{ left: 0, top: 0, x: p.currentX, y: p.currentY }}
            >
              <svg width="80" height="80" viewBox="0 0 50 50">
                <path
                  d={p.path}
                  fill={p.color}
                  className="stroke-slate-700 stroke-1 drop-shadow-lg"
                />
                {nivel <= 2 && (
                  <text 
                    x="25" y="25" 
                    className="text-[6px] fill-slate-800 font-bold pointer-events-none" 
                    textAnchor="middle"
                  >
                    {p.nombre}
                  </text>
                )}
              </svg>
            </motion.div>
          ))}
        </div>

        {/* Niveles de Dificultad (UI Inferior) */}
        <div className="absolute bottom-6 right-84 flex gap-2 items-center bg-green-800 p-2 rounded-xl border-2 border-white shadow-lg">
          <span className="text-white text-xs font-bold px-2">NIVELES:</span>
          {[1, 2, 3, 4].map(n => (
            <button
              key={n}
              onClick={() => setNivel(n)}
              className={`w-8 h-8 rounded-lg font-bold transition-all ${
                nivel === n ? 'bg-white text-green-800 scale-110' : 'bg-green-600 text-white hover:bg-green-500'
              }`}
            >
              {n}
            </button>
          ))}
        </div>
      </div>

      <div className="mt-4 text-slate-500 text-sm font-medium">
        Inspirado en los juegos educativos de Enrique Alonso
      </div>
    </div>
  );
}
