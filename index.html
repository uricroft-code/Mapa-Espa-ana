<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa de España — Puzzle por Provincias</title>

  <style>
    body{
      margin:0;
      background:#f5f7ff;
      font-family:system-ui,sans-serif;
      display:flex;
      justify-content:center;
    }
    .wrap{width:min(1280px,96vw);padding:16px}
    header{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      background:#eef2ff;
      border:1px solid #c7d2fe;
      border-radius:12px;
      padding:8px 12px;
      font-weight:600;
    }
    button{
      border:0;
      border-radius:10px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
    }
    .btn1{background:#f97316;color:#fff}
    .btn2{background:#ef4444;color:#fff}

    .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
      padding:12px;
    }

    #stage{
      width:100%;
      height:min(78vh,760px);
      border-radius:16px;
      overflow:hidden;
    }
    #stage svg{
      width:100%;
      height:100%;
      display:block;
    }

    /* Slots y piezas */
    .slot{
      fill:#f1f5f9;
      stroke:#94a3b8;
      stroke-width:1;
      stroke-dasharray:6 6;
      vector-effect: non-scaling-stroke;
      pointer-events:none;
    }
    .piece{
      fill:#60a5fa;
      stroke:#1e40af;
      stroke-width:1;
      vector-effect: non-scaling-stroke;
      cursor:grab;
      transition:transform .12s ease;
    }
    .piece.dragging{cursor:grabbing;opacity:.85}
    .piece.placed{
      pointer-events:none;
      filter: drop-shadow(0 3px 8px rgba(0,0,0,.18));
    }

    .hint{color:#374151;margin-top:10px;line-height:1.4}
    .list{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
      max-height:55vh;
      overflow:auto;
      padding-right:6px;
    }
    .chip{
      border:1px solid #bfdbfe;
      background:#eff6ff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      white-space:nowrap;
    }
    .ok{color:#16a34a;font-weight:700}
    .bad{color:#dc2626;font-weight:700}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="pill">Zona: España (provincias)</div>
      <div class="pill">Progreso: <span id="prog">0</span>/<span id="total">0</span></div>
      <button class="btn1" id="shuffle">Ordenar piezas</button>
      <button class="btn2" id="reset">Reiniciar</button>
    </header>

    <div class="grid">
      <div class="card" id="stage">
        <div id="loading" class="hint">Cargando mapa real…</div>
      </div>

      <div class="card">
        <b>Piezas disponibles</b>
        <div id="status" class="hint"></div>
        <div class="list" id="chips"></div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const STAGE = document.getElementById("stage");
  const LOADING = document.getElementById("loading");
  const PROG = document.getElementById("prog");
  const TOTAL = document.getElementById("total");
  const CHIPS = document.getElementById("chips");
  const STATUS = document.getElementById("status");

  const SNAP_DISTANCE = 35;
  const placed = new Set();

  /* === CARGA SVG === */
  let svgText="";
  try{
    const res = await fetch("./spain-provinces.svg");
    if(!res.ok) throw "";
    svgText = await res.text();
  }catch{
    STAGE.innerHTML = "<div class='bad'>No se encuentra spain-provinces.svg</div>";
    return;
  }
  LOADING?.remove();
  STAGE.insertAdjacentHTML("beforeend", svgText);

  const svg = STAGE.querySelector("svg");
  if(!svg){
    STAGE.innerHTML="<div class='bad'>SVG inválido</div>";
    return;
  }

  /* === LIMPIEZA DEL SVG === */
  svg.querySelectorAll("text").forEach(t=>t.remove());
  svg.querySelectorAll('[class*="label"],[id*="label"]').forEach(e=>e.remove());

  if(!svg.getAttribute("viewBox")){
    const w=svg.getAttribute("width")||1000;
    const h=svg.getAttribute("height")||1000;
    svg.setAttribute("viewBox",`0 0 ${w} ${h}`);
  }

  /* === DETECTAR PROVINCIAS ES-XX === */
  let provinceEls=[...svg.querySelectorAll('g[id^="ES-"]')];
  if(!provinceEls.length)
    provinceEls=[...svg.querySelectorAll('path[id^="ES-"]')];

  provinceEls.forEach(p=>p.setAttribute("data-province",p.id));
  if(!provinceEls.length){
    STATUS.innerHTML="<span class='bad'>No se detectan provincias ES-XX</span>";
    return;
  }
  STATUS.innerHTML=`<span class="ok">Provincias detectadas: ${provinceEls.length}</span>`;

  /* === TABLERO === */
  const board=document.createElementNS("http://www.w3.org/2000/svg","g");
  const pieces=document.createElementNS("http://www.w3.org/2000/svg","g");
  svg.innerHTML="";
  svg.append(board,pieces);

  const provinces=[];
  for(const o of provinceEls){
    const p=o.getAttribute("data-province");
    const s=o.cloneNode(true);
    s.removeAttribute("id");
    s.setAttribute("class","slot");
    s.setAttribute("data-province",p);
    board.appendChild(s);

    const pc=o.cloneNode(true);
    pc.removeAttribute("id");
    pc.setAttribute("class","piece");
    pc.setAttribute("data-province",p);
    pieces.appendChild(pc);

    provinces.push(p);
  }

  TOTAL.textContent=provinces.length;
  PROG.textContent=0;

  CHIPS.innerHTML="";
  provinces.forEach(p=>{
    const c=document.createElement("div");
    c.className="chip";
    c.textContent=p;
    CHIPS.appendChild(c);
  });

  /* === ORDENAR PIEZAS === */
  function shuffle(){
    const els=[...pieces.querySelectorAll(".piece")].filter(e=>!e.classList.contains("placed"));
    const cols=2,gx=120,gy=80,sx=20,sy=20;
    els.forEach((el,i)=>{
      const b=el.getBBox();
      const x=sx+(i%cols)*gx-b.x;
      const y=sy+Math.floor(i/cols)*gy-b.y;
      el.setAttribute("transform",`translate(${x},${y})`);
    });
  }
  shuffle();

  /* === DRAG & SNAP === */
  let act=null,pt=null,tr={x:0,y:0};
  const sp=e=>{
    const p=svg.createSVGPoint();
    p.x=e.clientX;p.y=e.clientY;
    return p.matrixTransform(svg.getScreenCTM().inverse());
  };
  const gt=e=>{
    const m=/translate\(([-\d.]+),([-\d.]+)\)/.exec(e.getAttribute("transform")||"");
    return m?{x:+m[1],y:+m[2]}:{x:0,y:0};
  };
  const st=(e,x,y)=>e.setAttribute("transform",`translate(${x},${y})`);
  const ctr=e=>{
    const b=e.getBBox();
    return {x:b.x+b.width/2,y:b.y+b.height/2,box:b};
  };
  const snap=e=>{
    const id=e.getAttribute("data-province");
    const s=board.querySelector(`.slot[data-province="${id}"]`);
    const a=ctr(e),b=ctr(s);
    if(Math.hypot(a.x-b.x,a.y-b.y)>SNAP_DISTANCE)return false;
    st(e,b.box.x-a.box.x,b.box.y-a.box.y);
    e.classList.add("placed");
    placed.add(id);
    PROG.textContent=placed.size;
    if(placed.size===provinces.length)alert("¡Mapa completado!");
    return true;
  };

  svg.addEventListener("pointerdown",e=>{
    const t=e.target.closest(".piece");
    if(!t||t.classList.contains("placed"))return;
    act=t;act.classList.add("dragging");
    pieces.appendChild(act);
    pt=sp(e);tr=gt(act);
  });
  window.addEventListener("pointermove",e=>{
    if(!act)return;
    const p=sp(e);
    st(act,tr.x+p.x-pt.x,tr.y+p.y-pt.y);
  });
  window.addEventListener("pointerup",()=>{
    if(!act)return;
    act.classList.remove("dragging");
    if(!snap(act))shuffle();
    act=null;
  });

  document.getElementById("shuffle").onclick=shuffle;
  document.getElementById("reset").onclick=()=>{
    placed.clear();PROG.textContent=0;
    pieces.querySelectorAll(".piece").forEach(p=>{
      p.classList.remove("placed");
      p.setAttribute("transform","translate(0,0)");
    });
    shuffle();
  };
})();
</script>
</body>
</html>
